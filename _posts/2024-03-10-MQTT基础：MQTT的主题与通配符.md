---
title: MQTT基础：MQTT的主题与通配符
image:
  path: https://assets.emqx.com/images/549b77fa672290d39f799fa7e47e7e8e.png?imageMogr2/thumbnail/1520x684	
  width: 100%
---

## 什么是MQTT主题？

我们知道MQTT的主题其实就是一个字符串，是MQTT协议进行消息路由的依据，MQTT的主题使用`/`进行层，如：

```
chat/room/1
sensor/10/temperature
sensor/+/temperature
sensor/#
```

MQTT建议主题不以`/`开头或结尾，比如`/chat`或`chat/`都是不推荐的主题。

与消息队列（`Kafka`、`RocketMQ`）中的主题不同，MQTT主题不需要提前创建，MQTT的客户端在订阅或发布时会自动创建主题，开发者无需关心主题的创建，也不用手动删除主题。

下图是一个简单的MQTT订阅与发布流程：

![MQTT 发布订阅](https://raw.githubusercontent.com/tangjiali/note_asserts/master/齐简笔记/202403111352118.png)

## MQTT主题通配符

MQTT支持订阅者在订阅主题时使用通配符来一次性订阅多个主题：

- `+`，单层通配符；
- `#`，多层通配符。

### 单层通配符

`+`可以在订阅时匹配单个主题层级，使用时`+`必须占据整个层级。举例来说：

- `+`：有效订阅，匹配任何单层级主题，比如`version`、`name`等；
- `sensor/+`：有效订阅，匹配任何第一层级为`sensor`的两层级主题，比如`sensor/9527`，但不能匹配`sensor/9527/xyz`；
- `sensor/+/temperature`：有效订阅，匹配任何第一层级为`sensor`，第三层级为`temperature`的三层级主题，比如`sensor/9527/temperature`、`sensor/8356/temperature`，但是无法匹配`sensor/1/2/temperature`；
- `sensor+`：**无效订阅**，这里的`+`没有单独占据一个层级，因此是无效的订阅。

多层通配符

`#`是用于匹配主题中任意层级的通配符，和`+`一样，`#`必须占据多个完整的层级；`#`还必须是主题的最后一个字符。

- `sensor/#`，有效订阅，匹配第一层级为`sensor`的多层级主题，比如`sensor/9527`、`sensor/8356/temperature`等；
- `sensor/#/temperature`，无效订阅，因为这里的`#`不是主题的最后一个字符；
- `sensor/bedroom#`，无效订阅，因为`#`虽然是主题的最后一个字符，但没有占据整个层级。

## 以$开头的主题

### 系统主题

以`$SYS/`开头的主题是系统主题，主要用于获取MQTT服务器自身运行状态、消息统计、客户端上下线事件等数据。MQTT协议虽未明确规定`$SYS/`主题标准，但大多数MQTT服务器都遵循该[标准建议](https://github.com/mqtt/mqtt.org/wiki/SYS-Topics)。

EMQX服务器通过以下主题获取集群状态：

| 主题                                 | 说明              |
| ------------------------------------ | ----------------- |
| $SYS/brokers                         | EMQX 集群节点列表 |
| $SYS/brokers/emqx@127.0.0.1/version  | EMQX 版本         |
| $SYS/brokers/emqx@127.0.0.1/uptime   | EMQX 运行时间     |
| $SYS/brokers/emqx@127.0.0.1/datetime | EMQX 系统时间     |
| $SYS/brokers/emqx@127.0.0.1/sysdescr | EMQX 系统信息     |

EMQX 还支持客户端上下线事件、收发流量、消息收发、系统监控等丰富的系统主题，用户可通过订阅 `$SYS/#` 主题获取所有系统主题消息。详细请见：[EMQX 系统主题文档](https://www.emqx.io/docs/zh/v5.0/observability/mqtt-system-topics.html#客户端上下线事件)。

## 共享主题

共享主题是**MQTT 5.0**引入的新特性，用于在多个订阅者之间实现订阅的负载均衡。共享主题的主题以`$share/`为前缀，同时`$share/`不作为主题的一部分，只作为共享主题的标识。

## MQTT主题常见问题及解答

### 主题的层级及长度有什么限制吗？

MQTT 协议规定主题的长度为两个字节，因此主题最多可包含 **65,535** 个字符。

建议主题层级为 7 个以内。使用较短的主题名称和较少的主题层级意味着较少的资源消耗，例如 `my-home/room1/data` 比 `my/home/room1/data` 更好。

### 服务器对主题数量有限制吗？

不同消息服务器对最大主题数量的支持各不一致，目前 EMQX 的默认配置对主题数量没有限制，但是主题数量越多将会消耗越多的服务器内存。考虑到连接到 MQTT Broker 的设备数量一般较多，我们建议一个客户端订阅的主题数量最好控制在 10 个以内。

### 通配符主题订阅与普通主题订阅性能是否一致？

通配符主题订阅的性能弱于普通主题订阅，且会消耗更多的服务器资源，用户可根据实际业务情况选择订阅类型。

### 重叠订阅了普通主题和通配符主题时如何接收消息?

假如客户端同时订阅了 `#` 和 `test` 主题，当向 `test` 主题发送消息时，是否会收到两条重复消息？这取决于 MQTT broker 的实现，例如 EMQX 会为每个匹配的订阅发送消息。但是用户可以使用 MQTT 5.0 中的订阅标识符来区分消息来源，然后在客户端中根据订阅标识符来处理这类重复的消息。

### 同一个主题能被共享订阅与普通订阅同时使用吗？

可以，但是不建议同时使用。

### 常见的 MQTT 主题使用建议有哪些？

- 不建议使用 `#` 订阅所有主题；
- 不建议主题以 `/` 开头或结尾，例如 `/chat` 或 `chat/`；
- 不建议在主题里添加空格及非 ASCII 特殊字符；
- 同一主题层级内建议使用下划线 `_` 或横杆 `-` 连接单词（或者使用驼峰命名）；
- 尽量使用较少的主题层级；
- 当使用通配符时，将唯一值的主题层（例如设备号）越靠近第一层越好。例如，`device/00000001/command/#` 比`device/command/00000001/#` 更好。

